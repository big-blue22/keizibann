
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Tech Share Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.1/24/outline/academic-cap.svg" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.6.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "react": "https://esm.sh/react@^19.1.0"
  }
}
</script>
</head>
<body class="bg-slate-900 text-slate-100">
  <div id="root"></div>
  <script type="module">
// index.html の <script type="module"> の中身をこれに差し替える

import React, { useState, useCallback, useMemo, useEffect, StrictMode } from 'react';
import ReactDOM from 'react-dom/client';

// -- 定数や共通のコンポーネント --
const APP_TITLE = "AI技術共有ハブ";

const LoadingSpinner = ({ size = 'md' }) => {
  const sizeClasses = { sm: 'w-4 h-4 border-2', md: 'w-8 h-8 border-4', lg: 'w-12 h-12 border-[6px]' };
  return React.createElement('div', { className: `animate-spin rounded-full ${sizeClasses[size]} border-t-transparent border-purple-400`, role: "status" });
};

const Tag = ({ label }) => React.createElement('span', { className: "px-3 py-1 text-xs font-medium rounded-full bg-slate-700 text-slate-300" }, label);

// -- 投稿フォーム (PostForm) --
const PostForm = ({ onPostAdded }) => {
  const [url, setUrl] = useState('');
  const [originalContent, setOriginalContent] = useState('');
  const [summary, setSummary] = useState('');
  const [status, setStatus] = useState({ loading: false, error: null, success: null });

  const handleRefine = async () => {
    if (!originalContent.trim()) return;
    setStatus({ loading: true, error: null, success: null });
    try {
      const res = await fetch('/api/refine-content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ originalContent }),
      });
      if (!res.ok) throw new Error('AIによる推敲に失敗しました。');
      const data = await res.json();
      setSummary(data.refinedText);
      setStatus({ loading: false, error: null, success: 'AIが内容を整えました。' });
    } catch (err) {
      setStatus({ loading: false, error: err.message, success: null });
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!url.trim() || !summary.trim()) {
      setStatus({ loading: false, error: 'URLと共有する内容は必須です。', success: null });
      return;
    }
    setStatus({ loading: true, error: null, success: null });
    try {
      // 1. ラベルを分析
      const labelsRes = await fetch('/api/analyze-labels', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: summary }),
      });
      if (!labelsRes.ok) throw new Error('AIによるラベル分析に失敗しました。');
      const { labels } = await labelsRes.json();

      // 2. 投稿を作成
      const postRes = await fetch('/api/create-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, summary, labels }),
      });
      if (!postRes.ok) throw new Error('投稿の保存に失敗しました。');
      const { post } = await postRes.json();

      // 3. 成功処理
      onPostAdded(post); // Appコンポーネントに新しい投稿を通知
      setUrl('');
      setOriginalContent('');
      setSummary('');
      setStatus({ loading: false, error: null, success: '投稿が成功しました！' });
    } catch (err) {
      setStatus({ loading: false, error: err.message, success: null });
    }
  };

  return React.createElement('form', { onSubmit: handleSubmit, className: "p-6 bg-slate-800 rounded-xl space-y-4" },
    React.createElement('h2', { className: "text-2xl font-semibold text-purple-400" }, "発見を共有"),
    status.error && React.createElement('p', { className: "text-red-400" }, status.error),
    status.success && React.createElement('p', { className: "text-green-400" }, status.success),
    // URL入力
    React.createElement('div', null,
        React.createElement('label', { htmlFor: "url" }, "URL *"),
        React.createElement('input', { type: "url", id: "url", value: url, onChange: e => setUrl(e.target.value), required: true, className: "w-full p-2 bg-slate-700 rounded" })
    ),
    // 原文入力
    React.createElement('div', null,
        React.createElement('label', { htmlFor: "originalContent" }, "元の投稿本文 (任意)"),
        React.createElement('textarea', { id: "originalContent", value: originalContent, onChange: e => setOriginalContent(e.target.value), rows: 3, className: "w-full p-2 bg-slate-700 rounded" }),
        React.createElement('button', { type: "button", onClick: handleRefine, disabled: status.loading || !originalContent.trim(), className: "px-4 py-1.5 bg-sky-600 text-white rounded disabled:opacity-50" }, status.loading ? '処理中...' : 'AIに内容を整えてもらう')
    ),
    // 共有内容入力
    React.createElement('div', null,
        React.createElement('label', { htmlFor: "summary" }, "共有する内容 *"),
        React.createElement('textarea', { id: "summary", value: summary, onChange: e => setSummary(e.target.value), required: true, rows: 4, className: "w-full p-2 bg-slate-700 rounded" })
    ),
    // 投稿ボタン
    React.createElement('button', { type: "submit", disabled: status.loading, className: "w-full px-6 py-3 bg-green-600 text-white rounded disabled:opacity-50" }, status.loading ? React.createElement(LoadingSpinner, null) : '投稿する')
  );
};

// -- 投稿一覧 (PostList) --
const PostCard = ({ post }) => {
    return React.createElement('article', { className: "bg-slate-800 rounded-lg p-5 border border-slate-700" },
        React.createElement('p', { className: "text-sm text-purple-400" }, React.createElement('a', { href: post.url, target: "_blank", rel: "noopener noreferrer" }, post.url)),
        React.createElement('p', { className: "text-slate-300 my-2" }, post.summary),
        React.createElement('div', { className: "flex flex-wrap gap-2" }, post.labels.map(label => React.createElement(Tag, { key: label, label: label }))),
        React.createElement('p', { className: "text-xs text-slate-500 mt-3" }, new Date(post.createdAt).toLocaleString())
    );
};

const PostList = ({ posts }) => {
  // ここで投稿を新しい順にソートする
  const sortedPosts = [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  return React.createElement('div', { className: "space-y-8" },
    sortedPosts.length === 0
      ? React.createElement('p', { className: "text-center text-slate-400" }, "まだ投稿はありません。")
      : sortedPosts.map(post => React.createElement(PostCard, { key: post.id, post: post }))
  );
};

// -- メインアプリケーション (App) --
const App = () => {
  const [posts, setPosts] = useState(null); // 初期状態をnullにしてローディング中を表現
  const [error, setError] = useState(null);

  // ページ読み込み時に投稿を取得
  useEffect(() => {
    const fetchPosts = async () => {
      try {
        const res = await fetch('/api/get-posts');
        if (!res.ok) throw new Error('投稿の読み込みに失敗しました。');
        const data = await res.json();
        setPosts(data);
      } catch (err) {
        setError(err.message);
      }
    };
    fetchPosts();
  }, []); // 空の配列で、初回の一度だけ実行

  // 新しい投稿が追加された時の処理
  const handlePostAdded = (newPost) => {
    setPosts(currentPosts => [newPost, ...(currentPosts || [])]); // Ensure currentPosts is an array
  };

  const renderContent = () => {
    if (error) {
      return React.createElement('p', { className: "text-red-400 text-center" }, `エラー: ${error}`);
    }
    if (posts === null) {
      return React.createElement('div', { className: "flex justify-center p-8" }, React.createElement(LoadingSpinner, { size: 'lg' }));
    }
    // ここでPostFormとPostListの両方を表示する
    return React.createElement(React.Fragment, null,
      React.createElement('div', { className: "mb-12" }, React.createElement(PostForm, { onPostAdded: handlePostAdded })),
      React.createElement(PostList, { posts: posts })
    );
  };

  return React.createElement('div', { className: "min-h-screen bg-slate-900 text-slate-100" },
    React.createElement('header', { className: "bg-slate-800 p-4" },
      React.createElement('h1', { className: "text-3xl font-bold text-purple-400 text-center" }, APP_TITLE)
    ),
    React.createElement('main', { className: "container mx-auto px-4 py-8" },
      React.createElement('div', { className: "max-w-3xl mx-auto" },
        renderContent()
      )
    ),
    React.createElement('footer', { className: "text-center py-6 text-sm text-slate-500" }, `© ${new Date().getFullYear()} ${APP_TITLE}`)
  );
};

// -- ReactDOMでレンダリング --
const rootElement = document.getElementById('root');
if (!rootElement) throw new Error("Could not find root element");
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(StrictMode, null, React.createElement(App, null)));
  </script>
</body>
</html>
