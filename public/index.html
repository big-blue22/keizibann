<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Tech Share Hub</title>
  <meta name="description" content="AIæŠ€è¡“ã‚’å…±æœ‰ã—ã€å­¦ã³åˆã†ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ">
  <meta name="theme-color" content="#a855f7">
  <meta name="content-encoding" content="utf-8">
  <meta name="language" content="ja-JP">
  <script src="/btoa-polyfill.js"></script>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/dist/output.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.1/24/outline/academic-cap.svg" rel="stylesheet">
<script>
// æ¥µåŠ›æ—©æœŸã«btoaã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½å¯¾ç­–ï¼‰
(function() {
  if (typeof btoa !== 'undefined') {
    const originalBtoa = btoa;
    function safeBtoa(str) {
      try {
        return originalBtoa(str);
      } catch (error) {
        if (error.name === 'InvalidCharacterError') {
          try {
            return originalBtoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, 
              (match, p1) => String.fromCharCode(parseInt('0x' + p1))));
          } catch (e) {
            return '';
          }
        }
        throw error;
      }
    }
    
    // è¤‡æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’è©¦è¡Œ
    try { window.btoa = safeBtoa; } catch(e) {}
    try { self.btoa = safeBtoa; } catch(e) {}
    try { globalThis.btoa = safeBtoa; } catch(e) {}
    try { btoa = safeBtoa; } catch(e) {}
  }
})();
</script>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.6.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "react": "https://esm.sh/react@^19.1.0"
  }
}
</script>
</head>
<body class="bg-slate-900 text-slate-100">
  <div id="root"></div>
  <script type="module">
// åŒ…æ‹¬çš„ãªUTF-8å¯¾å¿œBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
(function() {
  'use strict';
  
  // UTF-8å¯¾å¿œã®å®‰å…¨ãªBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–¢æ•°
  function createSafeBtoa(originalBtoa) {
    return function(str) {
      try {
        return originalBtoa(str);
      } catch (error) {
        if (error.name === 'InvalidCharacterError') {
          // UTF-8æ–‡å­—åˆ—ã‚’å®‰å…¨ã«Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
          try {
            return originalBtoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
              return String.fromCharCode(parseInt('0x' + p1));
            }));
          } catch (fallbackError) {
            console.warn('Base64 encoding failed for:', str, fallbackError);
            return '';
          }
        }
        throw error;
      }
    };
  }
  
  // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®btoaã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
  if (typeof window !== 'undefined' && window.btoa) {
    const originalWindowBtoa = window.btoa;
    window.btoa = createSafeBtoa(originalWindowBtoa);
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã®btoaã‚‚ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
  if (typeof self !== 'undefined' && self.btoa && self !== window) {
    const originalSelfBtoa = self.btoa;
    self.btoa = createSafeBtoa(originalSelfBtoa);
  }
  
  // globalThisã§ã‚‚è©¦è¡Œï¼ˆæœ€æ–°ã®JavaScriptç’°å¢ƒå¯¾å¿œï¼‰
  if (typeof globalThis !== 'undefined' && globalThis.btoa) {
    const originalGlobalBtoa = globalThis.btoa;
    globalThis.btoa = createSafeBtoa(originalGlobalBtoa);
  }
})();

// index.html ã® <script type="module"> ã®ä¸­èº«ã‚’ã“ã‚Œã«å·®ã—æ›¿ãˆã‚‹

import React, { useState, useCallback, useMemo, useEffect, StrictMode } from 'react';
import ReactDOM from 'react-dom/client';

// -- å®šæ•°ã‚„å…±é€šã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --
const APP_TITLE = "AIæŠ€è¡“å…±æœ‰ãƒãƒ–";

const LoadingSpinner = ({ size = 'md' }) => {
  const sizeClasses = { sm: 'w-4 h-4 border-2', md: 'w-8 h-8 border-4', lg: 'w-12 h-12 border-[6px]' };
  return React.createElement('div', { className: `animate-spin rounded-full ${sizeClasses[size]} border-t-transparent border-purple-400`, role: "status" });
};

const Tag = ({ label }) => React.createElement('span', { className: "px-3 py-1 text-xs font-medium rounded-full bg-slate-700 text-slate-300" }, label);

// URLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const UrlPreview = ({ data, onClear }) => {
    if (!data) return null;
    
    return React.createElement('div', { className: 'bg-slate-700/50 rounded-lg p-4 border border-slate-600' },
        data.title && React.createElement('h4', { className: 'font-semibold text-slate-200 mb-2 line-clamp-2' }, data.title),
        data.description && React.createElement('p', { className: 'text-sm text-slate-400 mb-3' }, data.description),
        data.image && React.createElement('img', { 
            src: data.image, 
            alt: data.title || 'Preview image',
            className: 'w-full h-32 object-cover rounded mb-3',
            onError: (e) => { e.target.style.display = 'none'; }
        }),
        React.createElement('div', { className: 'flex justify-between items-center' },
            data.siteName && React.createElement('span', { className: 'text-xs text-slate-500' }, data.siteName),
            onClear && React.createElement('button', {
                onClick: onClear,
                className: 'text-xs text-slate-400 hover:text-slate-200 px-2 py-1 rounded'
            }, 'Ã—')
        )
    );
};

// -- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« --
const AdminLoginModal = ({ onLogin, onClose }) => {
    const [password, setPassword] = useState('');
    const [error, setError] = useState(null);
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError(null);
        setIsLoading(true);
        try {
            await onLogin(password);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return React.createElement('div', { className: "fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[100]", onClick: onClose },
        React.createElement('div', { className: "bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700 w-full max-w-sm", onClick: e => e.stopPropagation() },
            React.createElement('h2', { className: "text-xl font-semibold text-purple-400 mb-4" }, "ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³"),
            error && React.createElement('p', { className: "text-red-400 mb-4" }, error),
            React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                React.createElement('input', { type: "password", value: password, onChange: e => setPassword(e.target.value), required: true, placeholder: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", className: "w-full p-2 bg-slate-700 rounded" }),
                React.createElement('button', { type: "submit", disabled: isLoading, className: "w-full px-6 py-3 bg-green-600 text-white rounded disabled:opacity-50" }, isLoading ? React.createElement(LoadingSpinner, {size: 'sm'}) : 'ãƒ­ã‚°ã‚¤ãƒ³')
            )
        )
    );
};

// -- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  (PostForm) --
const PostForm = ({ onPostAdded }) => {
  const [url, setUrl] = useState('');
  const [originalContent, setOriginalContent] = useState('');
  const [summary, setSummary] = useState('');
  const [status, setStatus] = useState({ loading: false, error: null, success: null });
  
  // å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•å…¥åŠ›
  useEffect(() => {
    console.log('useEffect triggered, checking for shared data');
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('shared') === 'true') {
      console.log('Shared parameter detected');
      // localStorageã‹ã‚‰å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const pendingShareData = localStorage.getItem('pendingShare');
      if (pendingShareData) {
        try {
          const shareData = JSON.parse(pendingShareData);
          
          console.log('=== å…±æœ‰ãƒ‡ãƒ¼ã‚¿å‡¦ç† ===');
          console.log('å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿:', shareData);
          
          // URLã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆè¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ï¼‰
          let foundUrl = '';
          
          // 1. urlãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
          if (shareData.url && shareData.url.startsWith('http')) {
            foundUrl = shareData.url;
            console.log('URL found in url param:', foundUrl);
          }
          // 2. textãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰URLã‚’æŠ½å‡º
          else if (shareData.text) {
            const urlPattern = /https?:\/\/[^\s]+/;
            const match = shareData.text.match(urlPattern);
            if (match) {
              foundUrl = match[0];
              console.log('URL found in text param:', foundUrl);
            }
          }
          // 3. titleãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰URLã‚’æŠ½å‡º
          else if (shareData.title) {
            const urlPattern = /https?:\/\/[^\s]+/;
            const match = shareData.title.match(urlPattern);
            if (match) {
              foundUrl = match[0];
              console.log('URL found in title param:', foundUrl);
            }
          }
          
          // URLãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿å‡¦ç†
          if (foundUrl) {
            console.log('Before setUrl - current url state:', url);
            setUrl(foundUrl);
            console.log('After setUrl call - setting to:', foundUrl);
            
            // DOMè¦ç´ ã‚‚ç›´æ¥ç¢ºèª
            setTimeout(() => {
              const urlInput = document.getElementById('url');
              if (urlInput) {
                console.log('DOM input value after setState:', urlInput.value);
                // å¼·åˆ¶çš„ã«DOMè¦ç´ ã®å€¤ã‚‚è¨­å®š
                urlInput.value = foundUrl;
                console.log('Force set DOM value to:', foundUrl);
              }
            }, 100);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            setStatus({ loading: false, error: null, success: `å…±æœ‰ã•ã‚ŒãŸURLã€Œ${foundUrl}ã€ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼` });
          } else {
            console.log('No URL found in shared data');
            setStatus({ loading: false, error: 'URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', success: null });
          }
          
          // ä½¿ç”¨æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
          localStorage.removeItem('pendingShare');
          
          // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãªURLã«ã™ã‚‹ï¼‰
          window.history.replaceState({}, document.title, window.location.pathname);
          
        } catch (err) {
          console.error('Failed to parse share data:', err);
          setStatus({ loading: false, error: 'å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', success: null });
        }
      }
    }
  }, []);
  
  // URL state ã®å¤‰æ›´ã‚’ç›£è¦–
  useEffect(() => {
    console.log('URL state changed to:', url);
    if (url) {
      setTimeout(() => {
        const urlInput = document.getElementById('url');
        if (urlInput && urlInput.value !== url) {
          console.log('Force updating DOM input value from', urlInput.value, 'to', url);
          urlInput.value = url;
        }
      }, 50);
    }
  }, [url]);

  const handleRefine = async () => {
    if (!originalContent.trim()) return;
    setStatus({ loading: true, error: null, success: null });
    try {
      const res = await fetch('/api/refine-content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ originalContent }),
      });
      if (!res.ok) { const err = await res.json().catch(() => ({message: 'AIã«ã‚ˆã‚‹æ¨æ•²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚¨ãƒ©ãƒ¼ä¸æ˜'})); throw new Error(err.message || 'AIã«ã‚ˆã‚‹æ¨æ•²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
      const data = await res.json();
      setSummary(data.refinedText);
      setStatus({ loading: false, error: null, success: 'AIãŒå†…å®¹ã‚’æ•´ãˆã¾ã—ãŸã€‚' });
    } catch (err) {
      setStatus({ loading: false, error: err.message, success: null });
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!url.trim()) {
      setStatus({ loading: false, error: 'URLã¯å¿…é ˆã§ã™ã€‚', success: null });
      return;
    }
    setStatus({ loading: true, error: null, success: null });
    try {
      const labelsRes = await fetch('/api/analyze-labels', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: summary }),
      });
      if (!labelsRes.ok) { const err = await labelsRes.json().catch(() => ({message: 'AIã«ã‚ˆã‚‹ãƒ©ãƒ™ãƒ«åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚¨ãƒ©ãƒ¼ä¸æ˜'})); throw new Error(err.message || 'AIã«ã‚ˆã‚‹ãƒ©ãƒ™ãƒ«åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
      const { labels } = await labelsRes.json();

      const postRes = await fetch('/api/create-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, summary, labels }),
      });
      if (!postRes.ok) { const err = await postRes.json().catch(() => ({message: 'æŠ•ç¨¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚¨ãƒ©ãƒ¼ä¸æ˜'})); throw new Error(err.message || 'æŠ•ç¨¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
      const { post } = await postRes.json();

      onPostAdded(post);
      setUrl('');
      setOriginalContent('');
      setSummary('');
      setStatus({ loading: false, error: null, success: 'æŠ•ç¨¿ãŒæˆåŠŸã—ã¾ã—ãŸï¼' });
    } catch (err) {
      setStatus({ loading: false, error: err.message, success: null });
    }
  };

  return React.createElement('form', { onSubmit: handleSubmit, className: "p-6 bg-slate-800 rounded-xl space-y-4" },
    React.createElement('h2', { className: "text-2xl font-semibold text-purple-400" }, "ç™ºè¦‹ã‚’å…±æœ‰"),
    status.error && React.createElement('p', { className: "text-red-400" }, status.error),
    status.success && React.createElement('p', { className: "text-green-400" }, status.success),
    // URLå…¥åŠ›
    React.createElement('div', null,
        React.createElement('label', { htmlFor: "url" }, "URL *"),
        React.createElement('input', { 
            type: "url", 
            id: "url", 
            value: url, 
            onChange: e => setUrl(e.target.value), 
            required: true, 
            className: "w-full p-2 bg-slate-700 rounded" 
        })
    ),
    // åŸæ–‡å…¥åŠ›
    React.createElement('div', null,
        React.createElement('label', { htmlFor: "originalContent" }, "å…ƒã®æŠ•ç¨¿æœ¬æ–‡ (ä»»æ„)"),
        React.createElement('textarea', { id: "originalContent", value: originalContent, onChange: e => setOriginalContent(e.target.value), rows: 3, className: "w-full p-2 bg-slate-700 rounded" }),
        React.createElement('button', { type: "button", onClick: handleRefine, disabled: status.loading || !originalContent.trim(), className: "px-4 py-1.5 bg-sky-600 text-white rounded disabled:opacity-50" }, status.loading ? 'å‡¦ç†ä¸­...' : 'AIã«å†…å®¹ã‚’æ•´ãˆã¦ã‚‚ã‚‰ã†')
    ),
    // å…±æœ‰å†…å®¹å…¥åŠ›
    React.createElement('div', null,
        React.createElement('label', { htmlFor: "summary" }, "å…±æœ‰ã™ã‚‹å†…å®¹ (ä»»æ„)"),
        React.createElement('textarea', { id: "summary", value: summary, onChange: e => setSummary(e.target.value), required: false, rows: 4, className: "w-full p-2 bg-slate-700 rounded" })
    ),
    // æŠ•ç¨¿ãƒœã‚¿ãƒ³
    React.createElement('button', { type: "submit", disabled: status.loading, className: "w-full px-6 py-3 bg-green-600 text-white rounded disabled:opacity-50" }, status.loading ? React.createElement(LoadingSpinner, null) : 'æŠ•ç¨¿ã™ã‚‹')
  );
};

// -- æŠ•ç¨¿ä¸€è¦§ (PostList & PostCard) --
const PostCard = ({ post, isAdmin, onDelete, onPostUpdated }) => {
    const [showComments, setShowComments] = useState(false);
    const [comments, setComments] = useState([]);
    const [newCommentContent, setNewCommentContent] = useState('');
    const [commentStatus, setCommentStatus] = useState({ loading: false, error: null });
    const [currentPreviewData, setCurrentPreviewData] = useState(post.previewData);

    useEffect(() => {
        setCurrentPreviewData(post.previewData);
    }, [post.previewData]);

    // é–²è¦§æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆURLã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¿ï¼‰
    const incrementViewCount = async () => {
        try {
            const res = await fetch('/api/increment-view-count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId: post.id }),
            });
            
            if (res.status === 429) {
                // ã‚¹ãƒ­ãƒƒãƒˆãƒ«åˆ¶é™ã®å ´åˆã¯é™ã‹ã«ç„¡è¦–
                console.log('View count throttled for post:', post.id);
                return;
            }
            
            if (res.ok) {
                const data = await res.json();
                if (data.post) {
                    onPostUpdated(data.post); // æ›´æ–°ã•ã‚ŒãŸæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’Appã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ä¼ãˆã‚‹
                }
            }
        } catch (err) {
            console.error('Failed to increment view count:', err);
        }
    };

    const fetchComments = useCallback(async () => {
        setCommentStatus({ loading: true, error: null });
        try {
            const res = await fetch(`/api/get-comments?postId=${post.id}`);
            if (!res.ok) throw new Error('ã‚³ãƒ¡ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            const data = await res.json();
            setComments(data.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))); // å¤ã„é †ã«ã‚½ãƒ¼ãƒˆ
            setCommentStatus({ loading: false, error: null });
        } catch (err) {
            console.error('Failed to fetch comments:', err);
            setCommentStatus({ loading: false, error: err.message });
        }
    }, [post.id]);

    useEffect(() => {
        if (showComments) {
            fetchComments();
        }
    }, [showComments, fetchComments]);

    const handleAddComment = async (e) => {
        e.preventDefault();
        if (!newCommentContent.trim()) return;

        setCommentStatus({ loading: true, error: null });
        try {
            const res = await fetch('/api/add-comment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId: post.id, commentContent: newCommentContent }),
            });
            if (!res.ok) throw new Error('ã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            const data = await res.json();
            setComments(prevComments => [...prevComments, data.comment].sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)));
            setNewCommentContent('');
            setCommentStatus({ loading: false, error: null });
            
            // æŠ•ç¨¿ã®ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ›´æ–°
            if (data.post) {
                onPostUpdated(data.post);
            } else {
                // APIã‹ã‚‰æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œãªã„å ´åˆã¯ã€æ‰‹å‹•ã§æ›´æ–°
                const updatedPost = { ...post, commentCount: (post.commentCount || 0) + 1 };
                onPostUpdated(updatedPost);
            }
        } catch (err) {
            console.error('Failed to add comment:', err);
            setCommentStatus({ loading: false, error: err.message });
        }
    };

    const handleDeleteComment = async (commentId) => {
        if (!window.confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            const token = localStorage.getItem('admin-token');
            const res = await fetch('/api/delete-comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ postId: post.id, commentId }),
            });
            if (!res.ok) { const err = await res.json().catch(() => ({ message: 'ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚¨ãƒ©ãƒ¼ä¸æ˜' })); throw new Error(err.message || 'ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
            setComments(prevComments => prevComments.filter(c => c.id !== commentId));
            
            // æŠ•ç¨¿ã®ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ›´æ–°
            const updatedPost = { ...post, commentCount: Math.max((post.commentCount || 1) - 1, 0) };
            onPostUpdated(updatedPost);
        } catch (err) {
            alert(err.message);
        }
    };

    // 24æ™‚é–“ä»¥å†…ã«æŠ•ç¨¿ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’åˆ¤å®š
    const isRecentPost = () => {
        const now = new Date();
        const postDate = new Date(post.createdAt);
        const timeDiff = now - postDate;
        const twentyFourHours = 24 * 60 * 60 * 1000; // 24æ™‚é–“ã‚’ãƒŸãƒªç§’ã§è¡¨ç¾
        return timeDiff <= twentyFourHours;
    };

    const isRecent = isRecentPost();

    return React.createElement('article', { 
        className: isRecent 
            ? "bg-green-800/30 border-green-600 rounded-lg p-5 border relative transition-all duration-300 ease-in-out transform hover:scale-[1.01] hover:border-green-400"
            : "bg-slate-800 rounded-lg p-5 border border-slate-700 relative transition-all duration-300 ease-in-out transform hover:scale-[1.01] hover:border-purple-500"
    },
        // 24æ™‚é–“ä»¥å†…ã®æŠ•ç¨¿ã«NEWãƒãƒƒã‚¸ã‚’è¡¨ç¤ºï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰ç„¡ã§ä½ç½®èª¿æ•´ï¼‰
        isRecent && React.createElement('div', {
            className: isAdmin 
                ? "absolute top-10 right-2 px-2 py-1 text-xs font-bold text-white bg-green-500 rounded-full shadow-lg"
                : "absolute top-2 right-2 px-2 py-1 text-xs font-bold text-white bg-green-500 rounded-full shadow-lg"
        }, "NEW"),
        isAdmin && React.createElement('button', {
            onClick: () => onDelete(post.id),
            className: "absolute top-2 right-2 px-2 py-1 text-xs text-red-300 bg-red-800 hover:bg-red-700 rounded"
        }, "å‰Šé™¤"),
        React.createElement('p', { className: "text-sm text-purple-400 truncate" }, React.createElement('a', {
            href: post.url,
            target: "_blank",
            rel: "noopener noreferrer",
            className: "hover:underline",
            onClick: incrementViewCount
        }, post.url)),
        React.createElement('p', { className: "text-slate-300 my-2 whitespace-pre-wrap" }, post.summary),
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰
        currentPreviewData && React.createElement('div', { className: "my-3" },
            React.createElement('div', { className: 'border-l-4 border-purple-500 pl-4' },
                React.createElement(UrlPreview, {
                    data: currentPreviewData,
                    onClear: () => setCurrentPreviewData(null)
                })
            )
        ),
        
        React.createElement('div', { className: "flex flex-wrap gap-2" }, post.labels.map(label => React.createElement(Tag, { key: label, label: label }))),
        React.createElement('p', { className: "text-xs text-slate-500 mt-3" }, new Date(post.createdAt).toLocaleString('ja-JP')),
        React.createElement('p', { className: "text-xs text-slate-500 mt-1" },
          `é–²è¦§æ•°: ç´¯è¨ˆ ${post.viewCount || 0} å› ï¼ ç›´è¿‘3æ—¥é–“ ${post.recentViewCount !== undefined ? post.recentViewCount : 0} å›`
        ),

        React.createElement('button', {
            onClick: () => setShowComments(!showComments),
            className: "mt-4 px-3 py-1 text-sm bg-slate-700 text-slate-300 rounded hover:bg-slate-600"
        }, showComments ? 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’éè¡¨ç¤º' : `ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º (${post.commentCount || 0})`),

        showComments && React.createElement('div', { className: "mt-4 pt-4 border-t border-slate-700" },
            React.createElement('h4', { className: "text-lg font-semibold text-slate-300 mb-3" }, "ã‚³ãƒ¡ãƒ³ãƒˆ"),
            commentStatus.loading && React.createElement(LoadingSpinner, { size: 'sm' }),
            commentStatus.error && React.createElement('p', { className: "text-red-400" }, `ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${commentStatus.error}`),
            comments.length === 0 && !commentStatus.loading && !commentStatus.error && React.createElement('p', { className: "text-slate-500" }, "ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"),
            React.createElement('div', { className: "space-y-3" },
                comments.map(comment => React.createElement('div', { key: comment.id, className: "bg-slate-700 p-3 rounded relative" },
                    isAdmin && React.createElement('button', {
                        onClick: () => handleDeleteComment(comment.id),
                        className: "absolute top-1 right-1 px-2 py-0.5 text-xs text-red-300 bg-red-800 hover:bg-red-700 rounded"
                    }, "å‰Šé™¤"),
                    React.createElement('p', { className: "text-slate-200 whitespace-pre-wrap" }, comment.commentContent),
                    React.createElement('p', { className: "text-xs text-slate-400 mt-1" }, new Date(comment.createdAt).toLocaleString('ja-JP'))
                ))
            ),
            React.createElement('form', { onSubmit: handleAddComment, className: "mt-4 flex space-x-2" },
                React.createElement('input', { type: "text", value: newCommentContent, onChange: e => setNewCommentContent(e.target.value), placeholder: "ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ...", className: "flex-grow p-2 bg-slate-700 rounded" }),
                React.createElement('button', { type: "submit", disabled: commentStatus.loading, className: "px-4 py-2 bg-purple-600 text-white rounded disabled:opacity-50" }, "é€ä¿¡")
            )
        )
    );
};

const PostList = ({ posts, isAdmin, onDelete, onPostUpdated }) => {
  const sortedPosts = [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  return React.createElement('div', { className: "space-y-8" },
    sortedPosts.map(post => React.createElement(PostCard, { key: post.id, post: post, isAdmin: isAdmin, onDelete: onDelete, onPostUpdated: onPostUpdated }))
  );
};

// -- â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šãƒ©ãƒ™ãƒ«çµã‚Šè¾¼ã¿UI (LabelCloud) â˜…â˜…â˜… --
const LabelCloud = ({ labels, activeFilter, onSelect }) => {
    if (labels.length === 0) return null;

    return React.createElement('div', { className: "mb-8 p-4 bg-slate-800/60 rounded-lg" },
        React.createElement('h3', { className: "text-sm font-semibold text-slate-300 mb-3" }, "ãƒ©ãƒ™ãƒ«ã§çµã‚Šè¾¼ã¿:"),
        React.createElement('div', { className: "flex flex-wrap gap-2 items-center" },
            React.createElement('button', {
                onClick: () => onSelect(null), // nullã‚’æ¸¡ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è§£é™¤
                className: `px-3 py-1.5 text-xs rounded-full ${!activeFilter ? 'bg-sky-500 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`
            }, "ã™ã¹ã¦è¡¨ç¤º"),
            labels.map(label => React.createElement('button', {
                key: label,
                onClick: () => onSelect(label),
                className: `px-3 py-1.5 text-xs rounded-full ${activeFilter === label ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`
            }, label))
        )
    );
};

// -- â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šä¸¦ã³æ›¿ãˆUI (SortControls) â˜…â˜…â˜… --
const SortControls = ({ sortOrder, onSortChange }) => {
    return React.createElement('div', { className: "mb-4 flex items-center gap-3" },
        React.createElement('label', { className: "text-sm font-medium text-slate-300" }, "ä¸¦ã³æ›¿ãˆ:"),
        React.createElement('select', {
            value: sortOrder,
            onChange: (e) => onSortChange(e.target.value),
            className: "px-3 py-1.5 bg-slate-700 text-slate-200 rounded border border-slate-600 focus:border-purple-400 focus:outline-none text-sm"
        },
            React.createElement('option', { value: 'newest' }, "æ–°è¦é †"),
            React.createElement('option', { value: 'recommended' }, "ãŠã™ã™ã‚é †")
        )
    );
};


// -- ãƒ˜ãƒƒãƒ€ãƒ¼ --
const Header = ({ isAdmin, onLoginClick, onLogoutClick }) => {
    return React.createElement('header', { className: "bg-slate-800 p-4 flex justify-between items-center" },
        React.createElement('h1', { className: "text-3xl font-bold text-purple-400 text-center" }, APP_TITLE),
        isAdmin 
            ? React.createElement('button', { onClick: onLogoutClick, className: "px-4 py-2 bg-red-600 text-white rounded" }, "ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰çµ‚äº†")
            : React.createElement('button', { onClick: onLoginClick, className: "px-4 py-2 bg-amber-500 text-white rounded" }, "ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰")
    );
};

// -- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (App) --
const App = () => {
  const [allPosts, setAllPosts] = useState(null); // DBã‹ã‚‰å–å¾—ã—ãŸå…¨ã¦ã®æŠ•ç¨¿
  const [error, setError] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [showLogin, setShowLogin] = useState(false);
  const [activeTab, setActiveTab] = useState('view'); // 'view' or 'create'
  
  // â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç®¡ç†ã™ã‚‹State â˜…â˜…â˜…
  const [activeLabelFilter, setActiveLabelFilter] = useState(null);
  
  // â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šä¸¦ã³æ›¿ãˆã‚’ç®¡ç†ã™ã‚‹State â˜…â˜…â˜…
  const [sortOrder, setSortOrder] = useState('newest'); // 'newest' or 'recommended'

  // åˆå›ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª & æŠ•ç¨¿ã‚’å–å¾—
  useEffect(() => {
    const token = localStorage.getItem('admin-token');
    if (token) setIsAdmin(true);
    
    // å…±æœ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€æ–°è¦æŠ•ç¨¿ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('shared') === 'true') {
      console.log('Shared content detected, switching to create tab');
      setActiveTab('create');
    }
    
    const fetchPosts = async () => {
      try {
        console.log('ğŸ“¡ Fetching posts from API...');
        const res = await fetch('/api/get-posts');
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || `HTTP ${res.status}: æŠ•ç¨¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
        }
        
        const data = await res.json();
        console.log(`âœ… Successfully fetched ${data.length} posts`);
        setAllPosts(data);
        
      } catch (err) {
        console.error('âŒ Error fetching posts:', err);
        setError(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
      }
    };
    fetchPosts();
  }, []);

  // â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šçµã‚Šè¾¼ã¿å¾Œã®æŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’è¨ˆç®— â˜…â˜…â˜…
  const filteredPosts = useMemo(() => {
    if (!allPosts) return [];
    if (!activeLabelFilter) {
      return allPosts; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒãªã‘ã‚Œã°å…¨ã¦ã®æŠ•ç¨¿ã‚’è¿”ã™
    }
    return allPosts.filter(post => post.labels.includes(activeLabelFilter));
  }, [allPosts, activeLabelFilter]);

  // â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šä¸¦ã³æ›¿ãˆã•ã‚ŒãŸæŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’è¨ˆç®— â˜…â˜…â˜…
  const sortedAndFilteredPosts = useMemo(() => {
    if (!filteredPosts) return [];
    
    const sorted = [...filteredPosts];
    
    if (sortOrder === 'newest') {
      // æ–°è¦é †ï¼šä½œæˆæ—¥æ™‚ã§é™é †
      sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    } else if (sortOrder === 'recommended') {
      // ãŠã™ã™ã‚é †ï¼šæ–°ã—ã•(ä½œæˆæ—¥æ™‚)ã¨ç›´è¿‘3æ—¥é–“ã®é–²è¦§æ•°ã‚’çµ„ã¿åˆã‚ã›
      sorted.sort((a, b) => {
        const now = new Date();
        const aDate = new Date(a.createdAt);
        const bDate = new Date(b.createdAt);
        
        // æ—¥æ•°ã®å·®ã‚’è¨ˆç®—ï¼ˆæ—¥å˜ä½ï¼‰
        const aDaysOld = Math.floor((now - aDate) / (1000 * 60 * 60 * 24));
        const bDaysOld = Math.floor((now - bDate) / (1000 * 60 * 60 * 24));
        
        // æ–°ã—ã•ã‚¹ã‚³ã‚¢ï¼š7æ—¥ä»¥å†…ã¯é«˜ã‚¹ã‚³ã‚¢ã€ãã‚Œä»¥é™ã¯å¾ã€…ã«æ¸›å°‘
        const aFreshnessScore = Math.max(0, 10 - Math.floor(aDaysOld / 7));
        const bFreshnessScore = Math.max(0, 10 - Math.floor(bDaysOld / 7));
        
        // ç›´è¿‘3æ—¥é–“ã®é–²è¦§æ•°
        const aRecentViews = a.recentViewCount || 0;
        const bRecentViews = b.recentViewCount || 0;
        
        // ç·åˆã‚¹ã‚³ã‚¢ï¼šæ–°ã—ã•ã‚¹ã‚³ã‚¢ + ç›´è¿‘é–²è¦§æ•°
        const aScore = aFreshnessScore + aRecentViews;
        const bScore = bFreshnessScore + bRecentViews;
        
        return bScore - aScore; // é™é †
      });
    }
    
    return sorted;
  }, [filteredPosts, sortOrder]);

  // â˜…â˜…â˜… æ–°æ©Ÿèƒ½ï¼šå…¨ã¦ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ©ãƒ™ãƒ«ã‚’è¨ˆç®— â˜…â˜…â˜…
  const uniqueLabels = useMemo(() => {
    if (!allPosts) return [];
    const labelSet = new Set();
    allPosts.forEach(post => post.labels.forEach(label => labelSet.add(label)));
    return Array.from(labelSet).sort((a, b) => a.localeCompare(b, 'ja-JP'));
  }, [allPosts]);


  const handlePostAdded = (newPost) => {
    setAllPosts(currentPosts => [newPost, ...(currentPosts || [])]);
    setActiveTab('view'); // æŠ•ç¨¿å¾Œã¯ä¸€è¦§è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹
  };

  const handlePostUpdated = (updatedPost) => {
    setAllPosts(currentPosts => {
      if (!currentPosts) return [];
      return currentPosts.map(p => p.id === updatedPost.id ? updatedPost : p);
    });
  };

  const handleLogin = async (password) => {
    const res = await fetch('/api/admin-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password }),
    });
    if (!res.ok) {
        const errData = await res.json().catch(() => ({message: 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚¨ãƒ©ãƒ¼ä¸æ˜'}));
        throw new Error(errData.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
    const { token } = await res.json();
    localStorage.setItem('admin-token', token);
    setIsAdmin(true);
    setShowLogin(false);
  };

  const handleLogout = () => {
    localStorage.removeItem('admin-token');
    setIsAdmin(false);
  };
  
  const handleDeletePost = async (postId) => {
      if (!window.confirm("ã“ã®æŠ•ç¨¿ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try {
          const token = localStorage.getItem('admin-token');
          const res = await fetch('/api/delete-post', {
              method: 'POST',
              headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ postId }),
          });
          if (!res.ok) { const err = await res.json().catch(() => ({message: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚¨ãƒ©ãƒ¼ä¸æ˜'})); throw new Error(err.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');}
          // æˆåŠŸã—ãŸã‚‰æŠ•ç¨¿ä¸€è¦§ã‚’æ›´æ–°
          setAllPosts(currentPosts => currentPosts.filter(p => p.id !== postId));
      } catch (err) {
          alert(err.message);
      }
  };

  const TabButton = ({ label, isActive, onClick }) => {
      const baseClasses = "px-6 py-2 text-lg font-medium rounded-t-lg transition-colors duration-200 focus:outline-none";
      const activeClasses = "bg-slate-800 text-purple-400";
      const inactiveClasses = "bg-slate-700 text-slate-400 hover:bg-slate-600";
      return React.createElement('button', { onClick, className: `${baseClasses} ${isActive ? activeClasses : inactiveClasses}` }, label);
  };

  const renderContent = () => {
    if (error) return React.createElement('p', { className: "text-red-400 text-center" }, `ã‚¨ãƒ©ãƒ¼: ${error}`);
    if (allPosts === null) return React.createElement('div', { className: "flex justify-center p-8" }, React.createElement(LoadingSpinner, { size: 'lg' }));
    
    const noPostsAfterFilter = sortedAndFilteredPosts.length === 0 && activeLabelFilter;
    const noPostsAtAll = allPosts.length === 0;

    const viewTabContent = React.createElement(React.Fragment, null,
        !noPostsAtAll && React.createElement(LabelCloud, { labels: uniqueLabels, activeFilter: activeLabelFilter, onSelect: setActiveLabelFilter }),
        !noPostsAtAll && React.createElement(SortControls, { sortOrder: sortOrder, onSortChange: setSortOrder }),
        sortedAndFilteredPosts.length > 0 && React.createElement(PostList, { posts: sortedAndFilteredPosts, isAdmin: isAdmin, onDelete: handleDeletePost, onPostUpdated: handlePostUpdated }),
        noPostsAfterFilter && React.createElement('p', { className: 'text-center text-slate-400 mt-8' }, `ã€Œ${activeLabelFilter}ã€ã«ä¸€è‡´ã™ã‚‹æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`),
        noPostsAtAll && React.createElement('p', { className: 'text-center text-slate-400 mt-8' }, `ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼`)
    );

    const createTabContent = React.createElement(PostForm, { onPostAdded: handlePostAdded });

    return React.createElement(React.Fragment, null,
        React.createElement('div', { className: "flex space-x-2 border-b border-slate-700" },
            React.createElement(TabButton, { label: "æŠ•ç¨¿ä¸€è¦§", isActive: activeTab === 'view', onClick: () => setActiveTab('view') }),
            React.createElement(TabButton, { label: "æ–°è¦æŠ•ç¨¿", isActive: activeTab === 'create', onClick: () => setActiveTab('create') })
        ),
        React.createElement('div', { className: "p-6 bg-slate-800 rounded-b-xl" },
            activeTab === 'view' ? viewTabContent : createTabContent
        )
    );
  };

  return React.createElement('div', { className: "min-h-screen bg-slate-900 text-slate-100" },
    React.createElement(Header, { isAdmin: isAdmin, onLoginClick: () => setShowLogin(true), onLogoutClick: handleLogout }),
    React.createElement('main', { className: "container mx-auto px-4 py-8" },
      React.createElement('div', { className: "max-w-3xl mx-auto" }, renderContent())
    ),
    React.createElement('footer', { className: "text-center py-6 text-sm text-slate-500" }, `Â© ${new Date().getFullYear()} ${APP_TITLE}`),
    showLogin && React.createElement(AdminLoginModal, { onLogin: handleLogin, onClose: () => setShowLogin(false) })
  );
};

// -- ReactDOMã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° --
const rootElement = document.getElementById('root');
if (!rootElement) throw new Error("Could not find root element");
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(StrictMode, null, React.createElement(App, null)));

// ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('Service Worker registered successfully:', registration.scope);
      })
      .catch((error) => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
  </script>
</body>
</html>
